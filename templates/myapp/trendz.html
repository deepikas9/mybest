{% extends 'base.html' %}
{% load static %}
{% block title %}TrendZ{% endblock %}
{% block content %}
<style>
  body { background-color: black; margin: 0; padding: 0; }
  .container { max-width: 600px; margin: 0 auto; padding: 40px 3px; background: black; }
  h2 { color: orangered; margin-bottom: 20px; }
  button[type="submit"] { background: orangered; color: white; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; }
  .post { background: black; box-shadow: 0 2px 8px rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 50px; padding: 10px; }
  .post-header img { width:45px; height:45px; border-radius:50%; object-fit:cover; margin-right:10px; }
  .emoji-bar { display:flex; justify-content: space-around; margin-top: 12px; padding: 8px 0; gap:10px; }
  .emoji-btn { cursor:pointer; text-align:center; width:50px; color:#ccc;display: inline-block; }
  .emoji-btn .icon { font-size:28px; display: inline-block; transition: transform 0.2s ease-in-out, color 0.15s ease; }
  .emoji-btn .count { margin-top:4px; font-size:13px; color:#ccc; }
  .emoji-btn:hover .icon { transform: scale(1.2); }
  .emoji-btn.active { color: white; transform: scale(1.2); }

  /* Menu for edit/delete */
  .post-menu {
    position: relative;
    display: inline-block;
  }
  .menu-btn {
    background: none;
    border: none;
    color: #aaa;
    font-size: 18px;
    cursor: pointer;
  }
  .menu-content {
    display: none;
    position: absolute;
    right: 0;
    background: #222;
    border-radius: 8px;
    min-width: 120px;
    z-index: 1;
  }
  .menu-content a {
    display: block;
    padding: 8px 12px;
    color: white;
    text-decoration: none;
    font-size: 14px;
  }
  .menu-content a:hover {
    background: #333;
  }
  .post-menu.show .menu-content {
    display: block;
  }

  /* Timestamp style */
  .post-time {
    color: #888;
    font-size: 0.6rem;
  }
</style>

<div class="container">
  <h2>Trending Posts üî•</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="submit_post">Post</button>
  </form>
  <hr>

  {% for post in top_posts %}
    <div class="post">
      <div class="post-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center;">
          {% if post.user.photo %}
            <img src="{{ post.user.photo.url }}" alt="User Photo">
          {% else %}
            <img src="{% static 'images/default-profile.png' %}" alt="User Photo">
          {% endif %}
          <div>
            <div style="font-weight:bold; font-size:0.9rem; color:#fff;">{{ post.user.full_name }}</div>
            <div style="color:#777; font-size:0.8rem;">@{{ post.user.username }}</div>
          </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
          <!-- Store UTC date in data attribute -->
          <span class="post-time" data-utc="{{ post.created_at|date:'c' }}"></span>

          {% if request.user == post.user %}
          <div class="post-menu">
            <button class="menu-btn">‚ãÆ</button>
            <div class="menu-content">
              <a href="{% url 'edit_post' post.id %}">‚úè Edit</a>
              <a href="{% url 'delete_post' post.id %}" onclick="return confirm('Are you sure you want to delete this post?');">üóë Delete</a>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if post.content %}
        <p style="margin-top:10px; color:#eee;">{{ post.content }}</p>
      {% endif %}
      {% if post.photo %}
        <img src="{{ post.photo.url }}" alt="Post image" style="width:100%; margin-top:10px; border-radius:10px;">
      {% endif %}

      <div class="emoji-bar" data-post-id="{{ post.id }}">
        {% for item in post.reactions_data %}
          <div class="emoji-btn{% if item.active %} active{% endif %}" data-emoji="{{ item.emoji }}">
            <span class="icon">{{ item.emoji }}</span>
            <span class="count">{{ item.count }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrftoken = document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];

  // Click handler for reactions
  document.querySelectorAll(".emoji-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const postId = btn.closest(".emoji-bar").dataset.postId;
      const emoji = btn.dataset.emoji;
      try {
        const res = await fetch("{% url 'emoji_reaction' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ post_id: postId, emoji })
        });
        const data = await res.json();
        if (data.success) {
          updatePostReactions(postId, data.reactions);
        } else {
          alert("Error updating reaction count.");
        }
      } catch (err) {
        console.error(err);
        alert("Could not register reaction. Try again.");
      }
    });
  });

  // Function to update DOM for a single post
  function updatePostReactions(postId, reactions) {
    const bar = document.querySelector(`.emoji-bar[data-post-id="${postId}"]`);
    if (!bar) return;
    reactions.forEach(r => {
      const btn = bar.querySelector(`.emoji-btn[data-emoji="${r.emoji}"]`);
      if (btn) {
        btn.querySelector(".count").textContent = r.count;
        btn.classList.toggle("active", r.active);
      }
    });
  }

  // Polling function to get live updates
  async function fetchReactions() {
    const postIds = Array.from(document.querySelectorAll(".emoji-bar"))
      .map(el => el.dataset.postId);
    if (!postIds.length) return;

    try {
      const res = await fetch("{% url 'get_reactions' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ post_ids: postIds })
      });
      const data = await res.json();
      if (data.success) {
        for (const [postId, reactions] of Object.entries(data.posts)) {
          updatePostReactions(postId, reactions);
        }
      }
    } catch (err) {
      console.error(err);
    }
  }

  // Poll every 5 seconds
  setInterval(fetchReactions, 1500);

  // Menu toggle
  document.querySelectorAll(".menu-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const menu = btn.parentElement;
      menu.classList.toggle("show");
    });
  });
  document.addEventListener("click", () => {
    document.querySelectorAll(".post-menu").forEach(menu => menu.classList.remove("show"));
  });

  // Local time conversion
  document.querySelectorAll(".post-time").forEach(el => {
    const utcDate = el.dataset.utc;
    if (utcDate) {
      const localDate = new Date(utcDate);
      const options = {
        hour: '2-digit',
        minute: '2-digit',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      };
      el.textContent = localDate.toLocaleString(undefined, options);
    }
  });
});
</script>

{% endblock %}
