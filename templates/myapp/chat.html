{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" href="{% static 'images/me-snip.jpg' %}" />
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" href="{% static 'images/me-snip.jpg' %}" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #0d0d0d;
      color: #fff;
      font-family: 'Segoe UI', Roboto, sans-serif;
      overflow: auto;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    /* ðŸŒŸ WhatsApp-style header */
    .chat-header {
      background-color: #161618;
      padding: 10px 16px;
      font-size: 1.1rem;
      font-weight: bold;
      color: orangered;
      position: fixed;
      top: 0;
      width: 100%;
      max-width: 600px;
      z-index: 10;
      border-bottom: 1px solid #2e2e2e;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-profile-pic {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .username-status {
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.2;
    }

    .username-status .name {
      color: orangered;
      font-weight: bold;
    }

    .username-status .status {
      font-size: 0.75rem;
      color: #ccc;
    }

    .header-icons {
      display: flex;
      align-items: center;
      gap: 30px;
    }
    .header-icons img,
.header-icons button img {
  height: 30px;
  width: 30px;
  object-fit: contain;
}

.header-icons button {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}

    .chat-messages {
      flex: 1;
      padding: 10px;
      padding-top: 65px;
      padding-bottom: 120px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #000;
      box-sizing: border-box;
    }

    .message {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
    }

    .sent {
      align-self: flex-end;
      background-color: #0095f6;
      color: white;
      border-bottom-right-radius: 0px;
    }

    .received {
      align-self: flex-start;
      background-color: #babcbf;
      color: black;
      border-bottom-left-radius: 0px;
    }

    .timestamp {
      font-size: 0.6rem;
      color: #000000;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 600px;
      background: black;
      padding: 8px 10px;
      z-index: 1001;
      box-sizing:border-box;
    }

    .chat-input-wrapper {
      position: relative;
      width: 100%;
    }
    .ticks {
      font-size: 0.7rem;
      color: whitesmoke;
      float: right;
      margin-left: 5px;
    }

    .chat-input textarea {
      width: 100%;
      min-height: 44px;
      max-height: 120px;
      resize: none;
      overflow: hidden;
      padding: 8px 60px 10px 10px;
      font-size: 1rem;
      border-radius: 24px;
      background: #222;
      border: 1px solid #444;
      color: whitesmoke;
      font-family: inherit;
      outline: none;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .chat-input button {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(to right, orangered, #ff4e00);
      border: none;
      color: white;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(255, 69, 0, 0.3);
      transition: all 0.25s ease;
    }

    .chat-input button:hover {
      background: linear-gradient(to right, #ff7043, #ff5722);
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 6px 14px rgba(255, 87, 34, 0.5);
    }
    .dropdown {
  position: relative;
}

.dropdown-content {
  display: none;
  position: absolute;
  right: 0;
  background-color: #222;
  border: 1px solid #444;
  z-index: 100;
  min-width: 140px;
  border-radius: 6px;
}

.dropdown-content a {
  color: white;
  padding: 10px;
  display: block;
  text-decoration: none;
  font-size: 0.9rem;
}

.dropdown-content a:hover {
  background-color: #333;
}

/* Modal styling */
.modal {
  display: none;
  position: fixed;
  z-index: 1002;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
}

.modal-content {
  background-color: #121212;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #888;
  max-width: 400px;
  color: white;
  border-radius: 12px;
  text-align: center;
}

.wallpaper-options {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.wallpaper-options img {
  width: 100px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
}


    @media (max-width: 600px) {
      .chat-header {
        font-size: 0.8rem;
        padding: 10px;
      }

      .chat-input button {
        padding: 9px 20px;
        font-size: 0.85rem;
      }

      .chat-input textarea {
        font-size: 0.95rem;
      }

      .header-profile-pic {
        height: 50px;
        width: 50px;
      }

      .header-icons img {
        height: 30px;
        width:30px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- ðŸŒŸ WhatsApp-Style Header -->
    <div class="chat-header">
      <div class="header-left">
        <a href="{% url 'home' %}">
          <img src="{% static 'images/BACK.png' %}" alt="Back" height="25px">
        </a>
        <img src="{% if bestie.photo %}{{ bestie.photo.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}" alt="Profile Pic" class="header-profile-pic" />
        <div class="username-status">
          <div class="name">{{ bestie.full_name|default:bestie.username }}</div>
          <div class="status" id="user-status">
            {% if is_online %}
              <span style="color:whitesmoke;">online</span>
            {% else %}
              <span>{{ last_seen_display }}</span>
            {% endif %}
          </div>
        </div>
      </div>
<div class="header-icons">
  <img src="{% static 'images/call_orangered.png' %}" alt="Call" title="Call" />

  <!-- 3-dots menu icon -->
  <div class="dropdown">
    <img src="{% static 'images/menu.png' %}" alt="Menu" onclick="toggleMenu()" style="cursor:pointer;">
    <div id="dropdown-menu" class="dropdown-content">
      <a href="#" onclick="deleteChat()">Delete Chat</a>
      <a href="#" onclick="openWallpaperSelector()">Select Wallpaper</a>
    </div>
  </div>
</div>

    </div>
    <video id="chat-bg-video" autoplay muted loop playsinline style="
  position: fixed;
  top: 65px;
  left: 0;
  width: 100%;
  height: calc(100% - 120px); /* account for input + header */
  object-fit: cover;
  z-index: -1;
  opacity: 0.3;
  pointer-events: none;
  display: none;">
  <source id="video-src" src="{% static 'videos/default.mp4' %}" type="video/mp4">
</video>


    <!-- ðŸ“¨ Message box â€” JS will populate messages -->
    <div class="chat-messages" id="chat-box">
      <p id="no-messages" style="text-align:center; color:#aaa;">No messages yet.</p>
    </div>

    <!-- ðŸ“ Input form -->
    <form method="post" class="chat-input">
      {% csrf_token %}
      <div class="chat-input-wrapper">
        <textarea name="message" rows="1" required placeholder="Type a message..."></textarea>
        <button type="submit">Send</button>
      </div>
    </form>
  </div>

  <audio id="notify-sound" src="{% static 'audio/online.mp3' %}" preload="auto"></audio>
</body>
</html>

  <!-- ðŸŽ¯ JS logic for fetching messages -->
<script>
  const chatBox = document.getElementById('chat-box');
  const textarea = document.querySelector('textarea[name="message"]');
  const form = document.querySelector('form.chat-input');
  const receiverId = "{{ bestie.id }}";
  const currentUsername = "{{ user.username }}";
  const messageSound = document.getElementById('notify-sound');

  let lastMessageTimestamp = null;
  let lastTypingSent = false;
  let typingTimer = null;

  // âœ… Handle session expiration
  function fetchWithSessionCheck(url, options = {}) {
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        "X-Requested-With": "XMLHttpRequest"
      }
    }).then(response => {
      if (response.status === 401) {
        alert("Your session has expired. Please log in again.");
        window.location.href = "/login/";
        throw new Error("Session expired");
      }
      return response;
    });
  }

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function formatLocalTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString(undefined, {
      day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
    });
  }

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, tag =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[tag])
    );
  }

  function appendMessage(msg) {
    document.getElementById('no-messages')?.remove();

    const div = document.createElement("div");
    div.classList.add("message", msg.sender === currentUsername ? "sent" : "received");
    if (msg.read) div.classList.add("read");

    let ticks = '';
    if (msg.sender === currentUsername) {
      ticks = msg.read ? '<span class="ticks">âœ“âœ“</span>' : '<span class="ticks">âœ“</span>';
    }

    div.innerHTML = `
      ${escapeHTML(msg.content).replace(/\n/g, "<br>")}
      <div class="timestamp">${formatLocalTime(msg.timestamp)} ${ticks}</div>
    `;
    chatBox.appendChild(div);
  }

  function fetchMessages() {
    fetchWithSessionCheck(`/chat/get_messages/${receiverId}/`)
      .then(response => response.json())
      .then(data => {
        const newMessages = data.messages || [];
        const filtered = lastMessageTimestamp
          ? newMessages.filter(msg => new Date(msg.timestamp) > new Date(lastMessageTimestamp))
          : newMessages;

        if (filtered.length > 0) {
          const newFromBestie = filtered.filter(msg => msg.sender !== currentUsername);
          if (newFromBestie.length > 0) messageSound.play();

          filtered.forEach(msg => appendMessage(msg));
          lastMessageTimestamp = newMessages[newMessages.length - 1].timestamp;
          scrollToBottom();
        }
      });
  }

  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const message = textarea.value.trim();
    if (message !== "") {
      fetchWithSessionCheck(`/chat/send_message/${receiverId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message })
      }).then(() => {
        textarea.value = "";
        textarea.style.height = "44px";
        fetchMessages();
      });
    }
  });

  textarea.addEventListener("input", () => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
    sendTypingStatus(true);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => sendTypingStatus(false), 3000);
  });

  textarea.addEventListener("focus", () => setTimeout(scrollToBottom, 300));

  textarea.addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.dispatchEvent(new Event("submit"));
    }
  });

  function sendTypingStatus(isTyping) {
    if (lastTypingSent === isTyping) return;
    fetchWithSessionCheck(`/chat/typing-status/${receiverId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ typing: isTyping })
    });
    lastTypingSent = isTyping;
  }

  function updateStatus() {
    fetchWithSessionCheck(`/chat/chat_status/{{ bestie.id }}/`)
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById("user-status");

        if (data.typing) {
          statusEl.innerHTML = '<span style="color:whitesmoke;">typing...</span>';
          return;
        }

        if (data.is_online) {
          statusEl.innerHTML = '<span style="color:whitesmoke;">online</span>';
          return;
        }

        if (data.last_seen_raw) {
          const seen = new Date(data.last_seen_raw);
          const now = new Date();
          const diffMs = now - seen;
          const diffMin = Math.floor(diffMs / 60000);

          const pad = (n) => (n < 10 ? "0" + n : n);
          const formatTime = (date) => {
            const hours = date.getHours();
            const mins = pad(date.getMinutes());
            const ampm = hours >= 12 ? 'pm' : 'am';
            const hour12 = hours % 12 === 0 ? 12 : hours % 12;
            return `${hour12}:${mins}${ampm}`;
          };
          const isSameDay = (d1, d2) =>
            d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();

          const isYesterday = (d1, d2) => {
            const yest = new Date(d1);
            yest.setDate(d1.getDate() - 1);
            return isSameDay(yest, d2);
          };

          if (diffMin < 60) {
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen ${diffMin} minute${diffMin !== 1 ? 's' : ''} ago</span>`;
          } else if (isSameDay(now, seen)) {
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen today at ${formatTime(seen)}</span>`;
          } else if (isYesterday(now, seen)) {
            statusEl.innerHTML = `<span style="font-size:0.7rem; color:#aaa;">last seen yesterday at ${formatTime(seen)}</span>`;
          } else {
            const dateStr = `${pad(seen.getDate())}/${pad(seen.getMonth() + 1)}/${String(seen.getFullYear()).slice(2)}`;
            statusEl.innerHTML = `<span style="font-size:0.65rem; color:#aaa;">last seen ${dateStr}, ${formatTime(seen)}</span>`;
          }
        } else {
          statusEl.innerHTML = '<span style="color:#aaa; font-size:0.75rem;">offline</span>';
        }
      });
  }

  function deleteChat() {
    if (confirm("Are you sure you want to delete the entire chat?")) {
      fetchWithSessionCheck(`/chat/delete_chat/${receiverId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      }).then(response => {
        if (response.ok) {
          chatBox.innerHTML = '<p id="no-messages" style="text-align:center; color:#aaa;">No messages yet.</p>';
          lastMessageTimestamp = null;
        } else {
          alert("Failed to delete chat.");
        }
      });
    }
  }

  setInterval(fetchMessages, 1000);  // Adjust as needed
  setInterval(updateStatus, 3000);
  fetchMessages();
  updateStatus();
</script>

<div id="wallpaper-modal" class="modal">
  <div class="modal-content">
    <h3>Select Wallpaper</h3>
    <div class="wallpaper-options">
      <img src="{% static 'images/Lovers.jpg' %}" onclick="setWallpaper(this.src)" />
      <img src="{% static 'images/lovebg1.jpg' %}" onclick="setWallpaper(this.src)" />
      <img src="{% static 'images/Default.jpg' %}" onclick="setWallpaper(this.src)" />
      <img src="{% static 'videos/Waterflow.mp4' %}" onclick="setWallpaper('{% static 'videos/Waterflow.mp4' %}')">

      <!-- Add more as needed -->
    </div>
    <button onclick="closeWallpaperSelector()">Cancel</button>
  </div>
</div>
<script>
  function toggleMenu() {
    const menu = document.getElementById("dropdown-menu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  window.onclick = function(event) {
    if (!event.target.matches('.dropdown img')) {
      const dropdowns = document.getElementsByClassName("dropdown-content");
      for (let i = 0; i < dropdowns.length; i++) {
        dropdowns[i].style.display = "none";
      }
    }
  };

  function openWallpaperSelector() {
    document.getElementById("wallpaper-modal").style.display = "block";
  }

  function closeWallpaperSelector() {
    document.getElementById("wallpaper-modal").style.display = "none";
  }

  function setWallpaper(src) {
    document.getElementById("chat-box").style.backgroundImage = `url('${src}')`;
    document.getElementById("chat-box").style.backgroundSize = "cover";
    document.getElementById("chat-box").style.backgroundPosition = "center";
    closeWallpaperSelector();
  }

function setWallpaper(src) {
  const ext = src.split('.').pop().toLowerCase();
  const video = document.getElementById("chat-bg-video");

  if (ext === 'mp4') {
    document.getElementById("video-src").src = src;
    video.load();
    video.style.display = "block";
    document.getElementById("chat-box").style.backgroundImage = "";
  } else {
    video.style.display = "none";
    document.getElementById("chat-box").style.backgroundImage = `url('${src}')`;
    document.getElementById("chat-box").style.backgroundSize = "cover";
    document.getElementById("chat-box").style.backgroundPosition = "center";
  }

  closeWallpaperSelector();
}
</script>

</body>

</html>
