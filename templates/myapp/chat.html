{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" href="{% static 'images/me-snip.jpg' %}" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #0d0d0d;
      color: #fff;
      font-family: 'Segoe UI', Roboto, sans-serif;
      overflow: auto;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .ticks {
      font-size: 0.7rem;
      color: whitesmoke;
      float: right;
      margin-left: 5px;
    }
    .read .ticks {
      color: whitesmoke;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      box-sizing: border-box;
    }
    .chat-header {
      background-color: #1f1f1f;
      padding: 14px 60px;
      font-size: 1.1rem;
      font-weight: bold;
      color: orangered;
      position: fixed;
      top: 0;
      width: 100%;
      max-width: 600px;
      z-index: 10;
      border-bottom: 1px solid #2e2e2e;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .chat-header a {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
    }
    .chat-header a img {
      height: 25px;
      width: auto;
    }
    .chat-header .username {
      text-align: center;
    }
    .chat-header .username div {
      display: block;
    }
    .chat-header .status {
      font-size: 0.7rem;
      color: #ccc;
    }

    .chat-messages {
      flex: 1;
      padding: 10px;
      padding-top: 60px;
      padding-bottom: 120px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #000;
      box-sizing: border-box;
    }

    .message {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
    }

    .sent {
      align-self: flex-end;
      background-color: #0095f6;
      color: white;
      border-bottom-right-radius: 0px;
    }

    .received {
      align-self: flex-start;
      background-color: #babcbf;
      color: black;
      border-bottom-left-radius: 0px;
    }

    .timestamp {
      font-size: 0.6rem;
      color: #10264a;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 600px;
      background: #111;
      padding: 8px 10px;
      z-index: 1001;
      box-sizing:border-box;
    }

    .chat-input-wrapper {
      position: relative;
      width: 100%;
    }

    .chat-input textarea {
      width: 100%;
      min-height: 44px;
      max-height: 120px;
      resize: none;
      overflow: hidden;
      padding: 8px 60px 10px 10px;
      font-size: 1rem;
      border-radius: 24px;
      background: #222;
      border: 1px solid #444;
      color: whitesmoke;
      font-family: inherit;
      outline: none;
      box-sizing: border-box;
      overflow-y: auto;
    }

    /*.chat-input button {*/
    /*  position: absolute;*/
    /*  right: 10px;*/
    /*  top: 50%;*/
    /*  transform: translateY(-50%);*/
    /*  background: orangered;*/
    /*  border: none;*/
    /*  color: white;*/
    /*  font-weight: bold;*/
    /*  padding: 8px 14px;*/
    /*  border-radius: 20px;*/
    /*  cursor: pointer;*/
    /*}*/
.chat-input button {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to right, orangered, #ff4e00);
  border: none;
  color: white;
  font-weight: bold;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 1rem;
  box-shadow: 0 4px 10px rgba(255, 69, 0, 0.3);
  transition: all 0.25s ease;
}

.chat-input button:hover {
  background: linear-gradient(to right, #ff7043, #ff5722);
  transform: translateY(-50%) scale(1.05);
  box-shadow: 0 6px 14px rgba(255, 87, 34, 0.5);
}


    @media (max-width: 600px) {
      .chat-header {
        font-size: 1rem;
        padding: 12px 50px;
      }

      .chat-input button {
        padding: 9px 20px;
        font-size: 0.85rem;
      }

      .chat-input textarea {
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    <a href="{% url 'home' %}"><img src="{% static 'images/homeicon_white.png' %}" alt="Home" /></a>
    <div class="username">
      <div>{{ bestie.full_name|default:bestie.username }}</div>
      <div class="status" id="user-status">
        {% if is_online %}
          <span style="color:whitesmoke;">online</span><br>
          <!-- <span style="font-size:0.65rem;">{{ last_seen_display }}</span> -->
        {% else %}
          <span style="font-size:0.75rem;">{{ last_seen_display }}</span>
        {% endif %}
      </div>
      <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">
  <button onclick="deleteChat()" title="Delete All Chat" style="
    background: none;
    border: none;
    color: #ff4e00;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: bold;
  ">ðŸ—‘</button>
</div>

    </div>
  </div>

  <div class="chat-messages" id="chat-box">
    {% for msg in messages %}
      <div class="message {% if msg.sender == user %}sent{% else %}received{% endif %}{% if msg.read %} read{% endif %}">
        {{ msg.message|linebreaksbr }}
        <div class="timestamp">
          {% if msg.sender == user %}
            <span class="ticks">{% if msg.read %}âœ“âœ“{% else %}âœ“{% endif %}</span>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p style="text-align:center; color:#aaa;">No messages yet.</p>
    {% endfor %}
  </div>

  <form method="post" class="chat-input">
    {% csrf_token %}
    <div class="chat-input-wrapper">
      <textarea name="message" rows="1" required placeholder="Type a message..."></textarea>
      <button type="submit">Send</button>
    </div>
  </form>
</div>

<audio id="notify-sound" src="{% static 'audio/online.mp3' %}" preload="auto"></audio>
<script>
  const chatBox = document.getElementById('chat-box');
  const textarea = document.querySelector('textarea[name="message"]');
  const form = document.querySelector('form.chat-input');
  const receiverId = "{{ bestie.id }}";
  const currentUsername = "{{ user.username }}";
  const messageSound = document.getElementById('notify-sound');

  let lastMessageTimestamp = null;
  let lastTypingSent = false;
  let typingTimer = null;

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function formatLocalTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString(undefined, {
      day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
    });
  }

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, tag =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[tag])
    );
  }

  function appendMessage(msg) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(msg.sender === currentUsername ? "sent" : "received");
    if (msg.read) div.classList.add("read");

    let ticks = '';
    if (msg.sender === currentUsername) {
      ticks = msg.read ? '<span class="ticks">âœ“âœ“</span>' : '<span class="ticks">âœ“</span>';
    }

    div.innerHTML = `
      ${escapeHTML(msg.content).replace(/\n/g, "<br>")}
      <div class="timestamp">${formatLocalTime(msg.timestamp)} ${ticks}</div>
    `;
    chatBox.appendChild(div);
  }

  function fetchMessages() {
    fetch(`/chat/get_messages/${receiverId}/`)
      .then(response => response.json())
      .then(data => {
        const newMessages = data.messages || [];

        const filtered = lastMessageTimestamp
          ? newMessages.filter(msg => new Date(msg.timestamp) > new Date(lastMessageTimestamp))
          : newMessages;

        if (filtered.length > 0) {
          const newFromBestie = filtered.filter(msg => msg.sender !== currentUsername);
          if (newFromBestie.length > 0) messageSound.play();

          filtered.forEach(msg => appendMessage(msg));

          lastMessageTimestamp = newMessages[newMessages.length - 1].timestamp;
          scrollToBottom();
        }
      });
  }

  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const message = textarea.value.trim();
    if (message !== "") {
      fetch(`/chat/send_message/${receiverId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message })
      }).then(() => {
        textarea.value = "";
        textarea.style.height = "44px";
        fetchMessages();
      });
    }
  });

  textarea.addEventListener("input", () => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
    sendTypingStatus(true);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => sendTypingStatus(false), 3000);
  });

  textarea.addEventListener("focus", () => {
    setTimeout(scrollToBottom, 300);
  });

  textarea.addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.dispatchEvent(new Event("submit"));
    }
  });

  function sendTypingStatus(isTyping) {
    if (lastTypingSent === isTyping) return;

    fetch(`/chat/typing-status/${receiverId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ typing: isTyping })
    });

    lastTypingSent = isTyping;
  }

  function updateStatus() {
    fetch(`/chat/chat_status/{{ bestie.id }}/`)
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById("user-status");

        if (data.typing) {
          statusEl.innerHTML = `<span style="color:whitesmoke;">typing...</span>`;
          return;
        }

        if (data.is_online) {
          statusEl.innerHTML = `<span style="color:whitesmoke;">online</span>`;
          return;
        }

        if (data.last_seen_raw) {
          const seen = new Date(data.last_seen_raw);
          const now = new Date();
          const diffMs = now - seen;
          const diffMin = Math.floor(diffMs / 60000);

          const pad = (n) => (n < 10 ? "0" + n : n);
          const formatTime = (date) => {
            const hours = date.getHours();
            const mins = pad(date.getMinutes());
            const ampm = hours >= 12 ? 'pm' : 'am';
            const hour12 = hours % 12 === 0 ? 12 : hours % 12;
            return `${hour12}:${mins}${ampm}`;
          };

          const isSameDay = (d1, d2) =>
            d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();

          const isYesterday = (d1, d2) => {
            const yest = new Date(d1);
            yest.setDate(d1.getDate() - 1);
            return isSameDay(yest, d2);
          };

          if (diffMin < 60) {
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen ${diffMin} minute${diffMin !== 1 ? 's' : ''} ago</span>`;
          } else if (isSameDay(now, seen)) {
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen today at ${formatTime(seen)}</span>`;
          } else if (isYesterday(now, seen)) {
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen yesterday at ${formatTime(seen)}</span>`;
          } else {
            const dateStr = `${pad(seen.getDate())}/${pad(seen.getMonth() + 1)}/${String(seen.getFullYear()).slice(2)}`;
            statusEl.innerHTML = `<span style="font-size:0.75rem; color:#aaa;">last seen on ${dateStr} ${formatTime(seen)}</span>`;
          }
        } else {
          statusEl.innerHTML = `<span style="color:#aaa; font-size:0.75rem;">offline</span>`;
        }
      });
  }

  function deleteChat() {
    if (confirm("Are you sure you want to delete the entire chat?")) {
      fetch(`/chat/delete_chat/${receiverId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      }).then(response => {
        if (response.ok) {
          chatBox.innerHTML = '<p style="text-align:center; color:#aaa;">No messages yet.</p>';
          lastMessageTimestamp = null;
        } else {
          alert("Failed to delete chat.");
        }
      });
    }
  }

  setInterval(fetchMessages, 1000);  // Adjusted for better performance
  setInterval(updateStatus, 3000);
  fetchMessages();
  updateStatus();
</script>

</body>

</html>
